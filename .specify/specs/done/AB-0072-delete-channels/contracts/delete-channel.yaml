# API Contract: Delete Channel
# Feature: AB-0072-delete-channels

# ─── Python Backend Endpoint ───────────────────────────────────────

# DELETE /v1/api/knowledge/channels/{channel_id}
#
# Performs full cleanup: vector store entries → transcript files → database records.
# Aborts if cleanup fails before reaching database deletion.

backend:
  method: DELETE
  path: /v1/api/knowledge/channels/{channel_id}
  path_params:
    channel_id:
      type: string
      format: uuid
      description: Supabase channel UUID
  query_params:
    user_id:
      type: string
      format: uuid
      required: true
      description: Authenticated user's ID (passed by Next.js API route)

  responses:
    200:
      description: Channel and all associated data successfully deleted
      body:
        channel_id: string       # UUID of deleted channel
        channel_title: string    # Title of deleted channel
        videos_deleted: integer  # Total videos removed from DB
        vectors_deleted: integer # Vector chunks removed from DeepLake
        files_deleted: integer   # Transcript files removed from disk
        message: string          # Human-readable summary

    404:
      description: Channel not found or not owned by user
      body:
        detail: string           # "Channel not found"

    409:
      description: Conflict — active transcription job for this channel
      body:
        detail: string           # "Cannot delete: transcription job in progress"
        job_id: string           # Active job ID

    500:
      description: Cleanup failed — deletion aborted
      body:
        detail: string           # "Vector store cleanup failed: {error}"
        phase: string            # "vector_store" | "transcript_files"
        channel_id: string       # Channel that was NOT deleted

# ─── Next.js API Route (BFF Proxy) ────────────────────────────────

# DELETE /api/channels/{channelId}
#
# Auth proxy: validates session, extracts user_id, forwards to backend.

nextjs_bff:
  method: DELETE
  path: /api/channels/[channelId]
  auth: required (Supabase session)

  responses:
    200:
      description: Proxied success from backend
      body: # Same as backend 200

    401:
      description: Not authenticated
      body:
        error: string            # "Not authenticated"

    # 404, 409, 500 proxied from backend

# ─── Bulk Delete Endpoint ─────────────────────────────────────────

# POST /v1/api/knowledge/channels/delete-bulk
#
# Deletes multiple channels. Processes each independently;
# continues on individual failures.

backend_bulk:
  method: POST
  path: /v1/api/knowledge/channels/delete-bulk
  body:
    channel_ids:
      type: array
      items: string (uuid)
      min_items: 1
      max_items: 50
    user_id:
      type: string
      format: uuid
      required: true

  responses:
    200:
      description: Bulk deletion results
      body:
        succeeded:
          type: array
          items:
            channel_id: string
            channel_title: string
            videos_deleted: integer
            vectors_deleted: integer
            files_deleted: integer
        failed:
          type: array
          items:
            channel_id: string
            channel_title: string
            error: string          # Reason for failure
        message: string            # Summary (e.g., "3 of 5 channels deleted")

# ─── Next.js Bulk BFF Route ──────────────────────────────────────

nextjs_bff_bulk:
  method: POST
  path: /api/channels/delete-bulk
  auth: required (Supabase session)
  body:
    channel_ids:
      type: array
      items: string (uuid)

  responses:
    200:
      description: Proxied bulk result from backend
    401:
      description: Not authenticated
